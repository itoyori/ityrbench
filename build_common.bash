#!/bin/bash
[[ -z "${PS1+x}" ]] && set -euo pipefail

MPICC=${MPICC:-mpicc}
MPICXX=${MPICXX:-mpicxx}

$MPICXX --version

CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_PROFILER_MODE=$KOCHI_PARAM_PROF"
CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_ORI_DEFAULT_MEM_MAPPER=$KOCHI_PARAM_DIST_POLICY"
CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_ORI_BLOCK_SIZE=$KOCHI_PARAM_BLOCK_SIZE"

case $KOCHI_PARAM_CACHE_POLICY in
  serial)            CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_ITO_SCHEDULER=serial -DITYR_ORI_CORE=serial" ;;
  nocache)           CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_ORI_CORE=nocache -DITYR_ORI_FORCE_GETPUT=1" ;;
  writethrough)      CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_ORI_ENABLE_LAZY_RELEASE=0 -DITYR_ORI_ENABLE_WRITE_THROUGH=1" ;;
  writeback)         CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_ORI_ENABLE_LAZY_RELEASE=0" ;;
  writeback_lazy)    CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_ORI_ENABLE_LAZY_RELEASE=1" ;;
  getput)            CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_ORI_ENABLE_LAZY_RELEASE=1 -DITYR_ORI_FORCE_GETPUT=1 -DITYR_ORI_ENABLE_VM_MAP=0" ;;
  *)                 echo "Unknown cache policy ($KOCHI_PARAM_CACHE_POLICY)"; exit 1 ;;
esac
