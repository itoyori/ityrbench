depends:
  - name: big-anns
    recipe: dataset

default_params:
  nodes: 1
  cores:
    - value: 48
      machines: [wisteria-o]
    - value: 76
      machines: [squid-c]
    - value: 6
      machines: [local]
  dataset: msspacev-1M
  max_fraction: 0.02

default_name: anns_hnsw_pbbs
default_queue: node_${nodes}
default_duplicates: 1

build:
  depend_params: []
  script: |
    source build_common.bash

    cd anns_pbbs/benchmarks/ANN/HNSW
    $CXX -O3 -g -std=c++17 -Wall -Wextra -Wl,--unresolved-symbols=ignore-all -I../bench ${CXXFLAGS:+$CXXFLAGS} -o calc_recall calc_recall.cpp -lpthread

run:
  depend_params: [max_fraction, nodes, cores, dataset]
  script: |
    source run_common.bash

    n_nodes=$(echo $KOCHI_PARAM_NODES | cut -f 1 -d ":" | sed 's/x/*/g' | bc)
    if [[ $n_nodes != 1 ]]; then
      echo "The number of nodes must be 1."
      exit 1
    fi

    cd anns_pbbs/benchmarks/ANN/HNSW

    dataset_prefix=${KOCHI_PARAM_DATASET%-*}
    dataset_suffix=${KOCHI_PARAM_DATASET#*-}

    case $dataset_suffix in
      1M)
        dataset_nb=1000000
        export scale=1
        ;;
      *) echo "Unknown dataset scale: $dataset_suffix"; exit 1 ;;
    esac

    case $dataset_prefix in
      msspacev)
        export dataset=MSSPACEV
        export dtype=int8
        export dist=L2
        export m=32
        export efc=128
        export alpha=0.83
        export file_in=${KOCHI_INSTALL_PREFIX_BIG_ANNS}/MSSPACEV1B/spacev1b_base.i8bin.crop_nb_${dataset_nb}:i8bin
        export file_q=${KOCHI_INSTALL_PREFIX_BIG_ANNS}/MSSPACEV1B/query.i8bin:i8bin
        export file_gt=${KOCHI_INSTALL_PREFIX_BIG_ANNS}/MSSPACEV1B/msspacev-gt-${dataset_suffix}:ubin
        export th=0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.95,0.99
        ;;
      *) echo "Unknown dataset name: $dataset_prefix"; exit 1 ;;
    esac

    export rr=10
    export ef=15,20,30,50,75,100,125,250,500
    export beta=1
    export warmup=0
    export save_graph=1
    export limit_eval=1
    export thread=$KOCHI_PARAM_CORES
    export RESULT_PREFIX=$(pwd)/results

    export max_fraction=$KOCHI_PARAM_MAX_FRACTION

    bash run_HNSW_single.sh
