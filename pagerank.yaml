depends:
  - name: itoyori
    recipe: release
  - name: gbbs
    recipe: dataset

default_params:
  nodes: 1
  cores:
    - value: 48
      machines: [wisteria-o]
    - value: 76
      machines: [squid-c]
    - value: 6
      machines: [local]
  real_type: double
  repeats: 11
  max_iters: 100
  dataset: rmat_20_24
  cutoff_v: 4096
  cutoff_e: 16384
  cutoff_g: 1048576
  exec_type: gpop # naive/gpop
  bin_width: 32768
  # common params
  serial: 0
  sched: randws # randws/adws
  cache_policy: writeback_lazy # nocache/writethrough/writeback/writeback_lazy/getput
  dist_policy: default # default/block/cyclic/block_adws
  cache_size: 256 # MB
  block_size: 65536 # bytes
  sub_block_size: 4096 # bytes
  max_dirty: $cache_size # MB
  noncoll_alloc_size: 64 # MB
  shared_mem: 1
  prof: disabled # disabled/stats/trace
  dag_prof: disabled # disabled/workspan
  cache_prof: disabled # disabled/stats
  debugger: 0

default_name: pagerank
default_queue: node_${nodes}
default_duplicates: 1

batches:
  serial:
    name: pagerank_${batch_name}
    queue: serial
    params:
      nodes: 1
      cores: 1
      serial: 1
      dataset: [rmat_26_30, twitter2010]
      exec_type: [naive, gpop]
    artifacts:
      - type: stdout
        dest: pagerank/${batch_name}/${dataset}_exec_${exec_type}_${duplicate}.log
      - type: stats
        dest: pagerank/${batch_name}/${dataset}_exec_${exec_type}_${duplicate}.stats
      - type: file
        src: mpirun_out.txt
        dest: pagerank/${batch_name}/${dataset}_exec_${exec_type}_${duplicate}.out

  strong:
    name: pagerank_${batch_name}
    params:
      nodes:
        - value: [1, 2:torus, 2x3:torus, 2x3x2:torus, 3x4x3:torus]
          machines: [wisteria-o]
        - value: [1, 2, 4, 8, 16]
          machines: [squid-c]
      dataset: [rmat_26_30, twitter2010]
      exec_type: [naive, gpop]
      sched: [randws, adws]
      cache_policy: [nocache, writeback_lazy]
    artifacts:
      - type: stdout
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.log
      - type: stats
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.stats
      - type: file
        src: mpirun_out.txt
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.out

  strong_prof:
    name: pagerank_${batch_name}
    params:
      nodes:
        - value: [1, 2:torus, 2x3:torus, 2x3x2:torus, 3x4x3:torus]
          machines: [wisteria-o]
        - value: [1, 2, 4, 8, 16]
          machines: [squid-c]
      dataset: [rmat_26_30, twitter2010]
      exec_type: [naive, gpop]
      sched: [randws, adws]
      cache_policy: [nocache, writeback_lazy]
      repeats: 3
      prof: stats
      dag_prof: workspan
      cache_prof: stats
    artifacts:
      - type: stdout
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.log
      - type: stats
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.stats
      - type: file
        src: mpirun_out.txt
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.out

  weak:
    name: pagerank_${batch_name}
    params:
      nodes:
        - value: [1, 2:torus, 2x2:torus, 2x2x2:torus, 4x4:torus]
          machines: [wisteria-o]
        - value: [1, 2, 4, 8, 16]
          machines: [squid-c]
      dataset: "`'_'.join(['rmat', str(len(bin(eval('$nodes'.split(':')[0].replace('x', '*')))) - 3 + 24), str(len(bin(eval('$nodes'.split(':')[0].replace('x', '*')))) - 3 + 28)])`"
      exec_type: [naive, gpop]
      sched: [randws, adws]
      cache_policy: [nocache, writeback_lazy]
    artifacts:
      - type: stdout
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.log
      - type: stats
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.stats
      - type: file
        src: mpirun_out.txt
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.out

  weak_prof:
    name: pagerank_${batch_name}
    params:
      nodes:
        - value: [1, 2:torus, 2x2:torus, 2x2x2:torus, 4x4:torus]
          machines: [wisteria-o]
        - value: [1, 2, 4, 8, 16]
          machines: [squid-c]
      dataset: "`'_'.join(['rmat', str(len(bin(eval('$nodes'.split(':')[0].replace('x', '*')))) - 3 + 24), str(len(bin(eval('$nodes'.split(':')[0].replace('x', '*')))) - 3 + 28)])`"
      exec_type: [naive, gpop]
      sched: [randws, adws]
      cache_policy: [nocache, writeback_lazy]
      repeats: 3
      prof: stats
      dag_prof: workspan
      cache_prof: stats
    artifacts:
      - type: stdout
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.log
      - type: stats
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.stats
      - type: file
        src: mpirun_out.txt
        dest: pagerank/${batch_name}/nodes_${nodes}_${dataset}_exec_${exec_type}_s_${sched}_p_${cache_policy}_${duplicate}.out

build:
  depend_params: [real_type, dist_policy, block_size, prof, dag_prof, cache_prof]
  script: |
    source build_common.bash

    CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYRBENCH_REAL_TYPE=$KOCHI_PARAM_REAL_TYPE"
    CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_ALLOCATOR_USE_DYNAMIC_WIN=false"

    CC=$MPICC CXX=$MPICXX cmake -DCMAKE_CXX_FLAGS="$CXXFLAGS" $CMAKE_OPTIONS .
    make clean
    make -j pagerank

run:
  depend_params: [nodes, cores, repeats, max_iters, dataset, cutoff_v, cutoff_e, cutoff_g, exec_type, bin_width, serial, sched, cache_policy, cache_size, sub_block_size, max_dirty, noncoll_alloc_size, shared_mem, prof, debugger]
  script: |
    source run_common.bash

    if [[ $KOCHI_PARAM_SERIAL == 1 ]]; then
      config_name=serial
    else
      config_name=${KOCHI_PARAM_SCHED}_${KOCHI_PARAM_CACHE_POLICY}
    fi

    case $KOCHI_PARAM_EXEC_TYPE in
      naive) exec_type_num=0 ;;
      gpop)  exec_type_num=1 ;;
      *)     echo "Unknown exec type"; exit 1 ;;
    esac

    commands="
      ./pagerank_${config_name}.out
        -r $KOCHI_PARAM_REPEATS
        -i $KOCHI_PARAM_MAX_ITERS
        -f ${KOCHI_INSTALL_PREFIX_GBBS}/${KOCHI_PARAM_DATASET}.bin
        -v $KOCHI_PARAM_CUTOFF_V
        -e $KOCHI_PARAM_CUTOFF_E
        -g $KOCHI_PARAM_CUTOFF_G
        -t $exec_type_num
        -b $KOCHI_PARAM_BIN_WIDTH"

    n_nodes=$(echo $KOCHI_PARAM_NODES | cut -f 1 -d ":" | sed 's/x/*/g' | bc)

    if [[ $KOCHI_PARAM_DEBUGGER == 0 ]]; then
      ityr_mpirun $((n_nodes * KOCHI_PARAM_CORES)) $KOCHI_PARAM_CORES core $commands
    else
      MPIEXEC=mpitx ityr_mpirun $((n_nodes * KOCHI_PARAM_CORES)) $KOCHI_PARAM_CORES core gdb --args $commands
    fi

    if [[ $KOCHI_PARAM_PROF == trace ]]; then run_trace_viewer; fi
