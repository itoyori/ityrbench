depends:
  - name: itoyori
    recipe: release
  - name: big-anns
    recipe: dataset

default_params:
  nodes: 1
  cores:
    - value: 48
      machines: [wisteria-o]
    - value: 76
      machines: [squid-c]
    - value: 6
      machines: [local]
  dataset: msspacev-1M
  repeats: 1
  n_points: default
  n_queries: default
  max_fraction: 0.02
  fast_check: 1
  # common params
  serial: 0
  sched: randws # randws/adws
  cache_policy: writeback_lazy # nocache/writethrough/writeback/writeback_lazy/getput
  dist_policy: default # default/block/cyclic/block_adws
  cache_size: 128 # MB
  block_size: 65536 # bytes
  sub_block_size: 512 # bytes
  max_dirty: $cache_size # MB
  noncoll_alloc_size: 128 # MB
  shared_mem: 1
  prof: disabled # disabled/stats/trace
  dag_prof: disabled # disabled/workspan
  cache_prof: disabled # disabled/stats
  debugger: 0

default_name: anns_hnsw
default_queue: node_${nodes}
default_duplicates: 1

batches:
  recall10M:
    name: anns_hnsw_${batch_name}
    params:
      nodes:
        - value: [1, 2x3x2:torus]
          machines: [wisteria-o]
        - value: [1, 8]
          machines: [squid-c]
      # dataset: [bigann-10M, msspacev-10M, text2image-10M]
      dataset: [bigann-10M, msspacev-10M]
      sched: adws
      repeats: 1
      max_fraction: 0.1
      fast_check: 0
      noncoll_alloc_size: "`(432 if '$nodes' == '1' else 324)`"
    artifacts:
      - type: stdout
        dest: anns_hnsw/${batch_name}/${dataset}_node_${nodes}_${duplicate}.log
      - type: stats
        dest: anns_hnsw/${batch_name}/${dataset}_node_${nodes}_${duplicate}.stats
      - type: file
        src: mpirun_out.txt
        dest: anns_hnsw/${batch_name}/${dataset}_node_${nodes}_${duplicate}.out
      - type: file
        src: log.csv
        dest: anns_hnsw/${batch_name}/${dataset}_node_${nodes}_${duplicate}.csv

  build10M:
    name: anns_hnsw_${batch_name}
    params:
      nodes:
        - value: [1, 2:torus, 2x3:torus, 2x3x2:torus]
          machines: [wisteria-o]
        - value: [1, 2, 4, 8, 16]
          machines: [squid-c]
      # dataset: [bigann-10M, msspacev-10M, text2image-10M]
      dataset: [bigann-10M, msspacev-10M]
      sched: [randws, adws]
      cache_policy: [nocache, writeback_lazy]
      repeats: 3
      max_fraction: 0.1
      fast_check: 1
      noncoll_alloc_size: "`(432 if '$nodes' == '1' else 324)`"
    artifacts:
      - type: stdout
        dest: anns_hnsw/${batch_name}/${dataset}_node_${nodes}_s_${sched}_p_${cache_policy}_${duplicate}.log
      - type: stats
        dest: anns_hnsw/${batch_name}/${dataset}_node_${nodes}_s_${sched}_p_${cache_policy}_${duplicate}.stats
      - type: file
        src: mpirun_out.txt
        dest: anns_hnsw/${batch_name}/${dataset}_node_${nodes}_s_${sched}_p_${cache_policy}_${duplicate}.out

build:
  depend_params: [dataset, dist_policy, block_size, prof, dag_prof, cache_prof]
  script: |
    source build_common.bash

    CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DITYR_ALLOCATOR_USE_DYNAMIC_WIN=false"

    dataset_prefix=${KOCHI_PARAM_DATASET%-*}
    case $dataset_prefix in
      bigann)
        CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DHNSW_DATA_TYPE=uint8_t"
        CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DHNSW_DIST_FUNC=l2"
        ;;
      msspacev)
        CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DHNSW_DATA_TYPE=int8_t"
        CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DHNSW_DIST_FUNC=l2"
        ;;
      text2image)
        CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DHNSW_DATA_TYPE=float"
        CXXFLAGS="${CXXFLAGS:+$CXXFLAGS} -DHNSW_DIST_FUNC=ndot"
        ;;
      *) echo "Unknown dataset name: $dataset_prefix"; exit 1 ;;
    esac

    CC=$MPICC CXX=$MPICXX cmake -DCMAKE_CXX_FLAGS="$CXXFLAGS" $CMAKE_OPTIONS .
    make clean
    make -j anns_hnsw

run:
  depend_params: [nodes, cores, dataset, repeats, n_points, n_queries, max_fraction, fast_check, serial, sched, cache_policy, cache_size, sub_block_size, max_dirty, noncoll_alloc_size, shared_mem, prof, debugger]
  script: |
    source run_common.bash

    if [[ $KOCHI_PARAM_SERIAL == 1 ]]; then
      config_name=serial
    else
      config_name=${KOCHI_PARAM_SCHED}_${KOCHI_PARAM_CACHE_POLICY}
    fi

    dataset_prefix=${KOCHI_PARAM_DATASET%-*}
    dataset_suffix=${KOCHI_PARAM_DATASET#*-}

    case $dataset_suffix in
      1M)   dataset_nb=1000000 ;;
      10M)  dataset_nb=10000000 ;;
      100M) dataset_nb=100000000 ;;
      *)    echo "Unknown dataset scale: $dataset_suffix"; exit 1 ;;
    esac

    opts=""

    if [[ $KOCHI_PARAM_N_POINTS == default ]]; then
      opts="$opts -n $dataset_nb"
    else
      opts="$opts -n $KOCHI_PARAM_N_POINTS"
    fi

    case $dataset_prefix in
      bigann)
        opts="$opts -m 32"
        opts="$opts -efc 128"
        opts="$opts -alpha 0.82"
        opts="$opts -type uint8"
        opts="$opts -dist L2"
        opts="$opts -in ${KOCHI_INSTALL_PREFIX_BIG_ANNS}/bigann/base.1B.u8bin.crop_nb_${dataset_nb}:u8bin"
        opts="$opts -q ${KOCHI_INSTALL_PREFIX_BIG_ANNS}/bigann/query.public.10K.u8bin:u8bin"
        opts="$opts -g ${KOCHI_INSTALL_PREFIX_BIG_ANNS}/bigann/bigann-${dataset_suffix}:ubin"
        opts="$opts -th 0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.95,0.99,0.999"
        ;;
      msspacev)
        opts="$opts -m 32"
        opts="$opts -efc 128"
        opts="$opts -alpha 0.83"
        opts="$opts -type int8"
        opts="$opts -dist L2"
        opts="$opts -in ${KOCHI_INSTALL_PREFIX_BIG_ANNS}/MSSPACEV1B/spacev1b_base.i8bin.crop_nb_${dataset_nb}:i8bin"
        opts="$opts -q ${KOCHI_INSTALL_PREFIX_BIG_ANNS}/MSSPACEV1B/query.i8bin:i8bin"
        opts="$opts -g ${KOCHI_INSTALL_PREFIX_BIG_ANNS}/MSSPACEV1B/msspacev-gt-${dataset_suffix}:ubin"
        opts="$opts -th 0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.95,0.99"
        ;;
      text2image)
        opts="$opts -m 32"
        opts="$opts -efc 128"
        opts="$opts -alpha 1.1"
        opts="$opts -in ${KOCHI_INSTALL_PREFIX_BIG_ANNS}/text2image1B/base.1B.fbin.crop_nb_${dataset_nb}:fbin"
        opts="$opts -q ${KOCHI_INSTALL_PREFIX_BIG_ANNS}/text2image1B/query.public.100K.fbin:fbin"
        opts="$opts -g ${KOCHI_INSTALL_PREFIX_BIG_ANNS}/text2image1B/text2image-${dataset_suffix}:ubin"
        opts="$opts -type float"
        opts="$opts -dist ndot"
        case $dataset_suffix in
          1M)   opts="$opts -th 0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.95,0.99,0.999" ;;
          10M)  opts="$opts -th 0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.95,0.99" ;;
          100M) opts="$opts -th 0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,0.95" ;;
        esac
        ;;
      *) echo "Unknown dataset name: $dataset_prefix"; exit 1 ;;
    esac

    if [[ $KOCHI_PARAM_N_QUERIES != default ]]; then
      opts="$opts -k $KOCHI_PARAM_N_QUERIES"
    fi

    opts="$opts -ml 0.36"
    opts="$opts -b 2"
    opts="$opts -f 0"
    opts="$opts -ef 15,20,30,50,75,100,125,250,500"
    opts="$opts -r 10"
    opts="$opts -beta 1"
    opts="$opts -w 0"
    opts="$opts -le 1"
    opts="$opts -i $KOCHI_PARAM_REPEATS"
    opts="$opts -mf $KOCHI_PARAM_MAX_FRACTION"
    opts="$opts -fc $KOCHI_PARAM_FAST_CHECK"

    commands="./anns_hnsw_${config_name}.out $opts"

    n_nodes=$(echo $KOCHI_PARAM_NODES | cut -f 1 -d ":" | sed 's/x/*/g' | bc)

    if [[ $KOCHI_PARAM_DEBUGGER == 0 ]]; then
      ityr_mpirun $((n_nodes * KOCHI_PARAM_CORES)) $KOCHI_PARAM_CORES core $commands
    else
      MPIEXEC=mpitx ityr_mpirun $((n_nodes * KOCHI_PARAM_CORES)) $KOCHI_PARAM_CORES core gdb --args $commands
    fi

    if [[ $KOCHI_PARAM_FAST_CHECK == 0 ]]; then
      python3 ./anns/benchmarks/ANN/HNSW/parse_kNN.py $STDOUT_FILE 0 log.csv
    fi

    if [[ $KOCHI_PARAM_PROF == trace ]]; then run_trace_viewer; fi
