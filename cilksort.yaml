depends:
  - name: massivethreads-dm
    recipe: release
  - name: pcas
    recipe: release
  - name: massivelogger
    recipe: release

default_params:
  nodes: 1
  cores:
    - value: 48
      machines: [wisteria-o]
    - value: 6
      machines: [local]
  n_input: 1_000_000
  repeats: 10
  exec_type: 2 # parallel
  policy: naive
  cache_size: 32
  verify: 0
  cutoff_i: 64
  cutoff_m: 16384
  cutoff_q: 16384
  trace: false

default_name: cilksort
default_queue: node_${nodes}
default_duplicates: 3

batches:
  serial:
    params:
      nodes: 1
      cores: 1
      exec_type: [0, 1] # serial, std_sort
      n_input: [10_000_000, 100_000_000]
      policy: serial
    duplicates: 1
    artifacts:
      - type: stdout
        dest: ${batch_name}/n_${n_input}_exec_${exec_type}_${duplicate}.log
      - type: stats
        dest: ${batch_name}/n_${n_input}_exec_${exec_type}_${duplicate}.stats
      - type: file
        src: mpirun_out.txt
        dest: ${batch_name}/n_${n_input}_exec_${exec_type}_${duplicate}.out

  scaling:
    name: cilksort_${batch_name}
    params:
      nodes:
        - value: [1, 2, 2x3, 2x3x2, 3x4x3, 6x6x4]
        # - value: [1, 2, 2x3]
          machines: [wisteria-o]
        - value: [1]
          machines: [local]
      n_input: [10_000_000, 100_000_000]
      policy: [naive, workfirst]
    artifacts:
      - type: stdout
        dest: ${batch_name}/nodes_${nodes}_n_${n_input}_p_${policy}_${duplicate}.log
      - type: stats
        dest: ${batch_name}/nodes_${nodes}_n_${n_input}_p_${policy}_${duplicate}.stats
      - type: file
        src: mpirun_out.txt
        dest: ${batch_name}/nodes_${nodes}_n_${n_input}_p_${policy}_${duplicate}.out

build:
  depend_params: [policy, trace]
  script: |
    source common.bash

    CFLAGS=${CFLAGS:-""}
    CFLAGS="$CFLAGS -DNDEBUG"
    CFLAGS="$CFLAGS -DITYR_POLICY=ityr_policy_$KOCHI_PARAM_POLICY"
    if $KOCHI_PARAM_TRACE; then
      CFLAGS="$CFLAGS -DPCAS_LOGGER_POLICY=policy_trace"
    fi

    make clean
    MPICXX=$MPICXX CFLAGS=$CFLAGS make cilksort.out

run:
  depend_params: [nodes, cores, n_input, repeats, exec_type, cache_size, verify, cutoff_i, cutoff_m, cutoff_q, trace]
  script: |
    source common.bash
    n_nodes=$(echo $KOCHI_PARAM_NODES | cut -f 1 -d ":" | sed 's/x/*/g' | bc)
    ityr_mpirun $((n_nodes * KOCHI_PARAM_CORES)) $KOCHI_PARAM_CORES ./cilksort.out \
      -n $KOCHI_PARAM_N_INPUT \
      -r $KOCHI_PARAM_REPEATS \
      -e $KOCHI_PARAM_EXEC_TYPE \
      -c $KOCHI_PARAM_CACHE_SIZE \
      -v $KOCHI_PARAM_VERIFY \
      -i $KOCHI_PARAM_CUTOFF_I \
      -m $KOCHI_PARAM_CUTOFF_M \
      -q $KOCHI_PARAM_CUTOFF_Q
    if $KOCHI_PARAM_TRACE; then run_trace_viewer; fi
